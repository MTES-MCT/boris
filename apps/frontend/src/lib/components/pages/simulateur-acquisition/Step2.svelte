<script lang="ts">
  import z, { ZodError } from 'zod';

  import type { FormFieldError } from '$lib/utils/definitions';
  import { formatFormErrors } from '$lib/utils/helpers';

  import Form from '$components/pages/simulateur-acquisition/Form.svelte';
  import Input from '$components/common/Input.svelte';

  import acquisitionSimulatorManager from '$lib/managers/acquisition-simulator.svelte';
  import Actions from '$components/pages/simulateur-acquisition/Actions.svelte';
  import Action from '$components/pages/simulateur-acquisition/Action.svelte';
  import Wrapper from '$components/pages/simulateur-acquisition/Wrapper.svelte';
  import Description from './Description.svelte';

  let { ownContribution, nextStep, previousStep, goToPreviousStep } = $derived(
    acquisitionSimulatorManager,
  );

  let errors: FormFieldError = $state({});

  const FormData = z.object({
    ownContribution: z
      .number()
      .gte(0, 'Veuillez saisir un chiffre supérieur à 0.')
      .optional(),
  });

  const handleSubmit = (e: SubmitEvent) => {
    e.preventDefault();

    try {
      FormData.parse({
        ownContribution: acquisitionSimulatorManager.ownContribution,
      });

      errors = {};

      acquisitionSimulatorManager.goToNextStep();
    } catch (e) {
      errors = formatFormErrors((e as ZodError).issues);
    }
  };
</script>

<Wrapper>
  <Description
    content="Renseignez le montant de votre apport personnel. Cela nous permet de
      calculer la part du financement que vous pouvez couvrir sans emprunter, et
      d'ajuster le besoin de crédit à solliciter." />
  <Form onSubmit={handleSubmit}>
    <div class="fieldset-container">
      <fieldset class="fr-fieldset">
        <div class="fr-fieldset__element">
          <Input
            value={ownContribution}
            label="Montant de votre apport (€)"
            labelTooltip="Somme dont vous disposez pour le projet (épargne, donation,
                aide familiale, etc.)."
            id="own-contribution"
            hint="Laissez le champs vide si vous n'avez pas d'apport"
            error={errors.ownContribution}
            type="number"
            placeholder="Exemple: 10 000€"
            onChange={(e) => {
              acquisitionSimulatorManager.ownContribution = Number(
                (e.target as HTMLInputElement).value,
              );
            }} />
        </div>
      </fieldset>
    </div>

    <Actions>
      <Action
        direction="previous"
        label={previousStep?.title as string}
        onClick={goToPreviousStep} />
      <Action
        direction="next"
        label={nextStep?.title as string}
        type="submit" />
    </Actions>
  </Form>
</Wrapper>
